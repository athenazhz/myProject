package com.qingniao.console.controller;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

import javax.servlet.http.HttpServletRequest;

import org.json.JSONObject;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;

import com.qingniao.core.utils.FastDFSClient;
import com.qingniao.core.utils.IDUtils;
import com.qingniao.core.utils.SERVER_URL;

@Controller
public class UploadController {
	//普通图片上传
	@ResponseBody
	@RequestMapping("/upload/uploadImg.do")
	public String imgUpload(@RequestParam MultipartFile picfile, HttpServletRequest request) throws IOException {
		//获取图片名称
		String originalFilename = picfile.getOriginalFilename();
		//获取图片扩展名
		String extraName = originalFilename.substring(originalFilename.lastIndexOf(".")+1);
		//生成图片的名字
		String newImgName = IDUtils.genImageName()+extraName;
		//生成图片路径
		String path = "/imgs/"+newImgName;
		//获取服务器的绝对路径
		String url = request.getSession().getServletContext().getRealPath("")+path;
		InputStream is = null;
		OutputStream out = null;
		try {
			is = picfile.getInputStream();
			out = new FileOutputStream(new File(url));
			byte[] b = new byte[1024];
			int count = 0;
			while ((count = is.read(b)) != -1) {
				out.write(b, 0, count);
			}
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			out.close();
			is.close();
		}
		JSONObject json = new JSONObject();
		json.put("path", path);
		return json.toString();
	}
	//图片上传到fastDFS
	@ResponseBody
	@RequestMapping("/upload/imgUploadToFastDFS.do")
	public String imgUploadToFastDFS(@RequestParam MultipartFile picfile) throws Exception {
		FastDFSClient fastDFSClient = new FastDFSClient("classpath:properties/fastDFS.properties");
		String fileName = picfile.getOriginalFilename();
		String extraName = fileName.substring(fileName.lastIndexOf(".")+1);
		String path = fastDFSClient.uploadFile(picfile.getBytes(), extraName);//保存到数据库
		String url = SERVER_URL.IMG_URL+path;//提供显示
		JSONObject json = new JSONObject();
		json.put("path", path);
		json.put("url", url);
		return json.toString();
	}
}
